<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>CaseA üéÅ</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script type="module">
    // ===== Firebase SDK =====
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
    import { getDatabase, ref, get, set, update } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-database.js";

    const firebaseConfig = {
¬† apiKey: "AIzaSyC9dXMaV_L0lFddoL_Ksz0ZtD6c-sVHWDg",
¬† authDomain: "case-b2d98.firebaseapp.com",
¬† databaseURL: "https://case-b2d98-default-rtdb.europe-west1.firebasedatabase.app",
¬† projectId: "case-b2d98",
¬† storageBucket: "case-b2d98.firebasestorage.app",
¬† messagingSenderId: "402247491014",
¬† appId: "1:402247491014:web:a5015a1e75c177d15326c7",
¬† measurementId: "G-6T04XJWNN7"
};

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    // ===== Telegram WebApp –¥–∞–Ω–Ω—ã–µ =====
    const tg = window.Telegram.WebApp;
    const user = tg.initDataUnsafe.user;
    const userId = user.id;

    // ===== –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è =====
    async function initUser() {
      const userRef = ref(db, `users/${userId}`);
      const snapshot = await get(userRef);

      if (!snapshot.exists()) {
        await set(userRef, {
          name: user.first_name,
          stars: 5, // –Ω–∞—á–∞–ª—å–Ω—ã–µ –∑–≤—ë–∑–¥—ã
          lastItem: "",
          lastPurchaseDate: ""
        });
      }

      updateUI();
    }

    // ===== –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞ =====
    async function updateUI() {
      const snapshot = await get(ref(db, `users/${userId}`));
      if (snapshot.exists()) {
        const data = snapshot.val();
        document.getElementById("userName").innerText =
          user.first_name + (user.last_name ? " " + user.last_name : "");
        if (user.photo_url) {
          document.getElementById("userPhoto").src = user.photo_url;
        }
        document.getElementById("stars").innerText = data.stars;
        document.getElementById("lastItem").innerText = data.lastItem || "-";
      }
    }

    // ===== –§—É–Ω–∫—Ü–∏—è –ø–æ–∫—É–ø–∫–∏ –∫–µ–π—Å–∞ –∑–∞ 1 –∑–≤–µ–∑–¥—É =====
    async function buyCase() {
      const userRef = ref(db, `users/${userId}`);
      const snapshot = await get(userRef);
      const data = snapshot.val();

      if (data.stars >= 1) {
        const rewards = ["üíé Diamond", "‚≠ê Gold", "üçÄ Lucky Clover"];
        const reward = rewards[Math.floor(Math.random() * rewards.length)];

        await update(userRef, {
          stars: data.stars - 1,
          lastItem: reward,
          lastPurchaseDate: new Date().toISOString()
        });

        alert(`üéâ –í—ã –æ—Ç–∫—Ä—ã–ª–∏ –∫–µ–π—Å –∏ –ø–æ–ª—É—á–∏–ª–∏: ${reward}`);
        updateUI();
      } else {
        alert("–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –∑–≤—ë–∑–¥ –¥–ª—è –æ—Ç–∫—Ä—ã—Ç–∏—è –∫–µ–π—Å–∞!");
      }
    }

    window.buyCase = buyCase;
    window.onload = initUser;

  </script>
  <style>
    body { font-family:sans-serif; text-align:center; padding:20px; background:#1c1c1c; color:white; }
    img { border-radius:50%; width:100px; height:100px; }
    button { padding:10px 20px; font-size:16px; background:#3390ec; color:white; border:none; border-radius:10px; cursor:pointer; margin-top:10px; }
    button:hover { background:#1c86ee; }
  </style>
</head>
<body>
  <h2 id="userName">–ó–∞–≥—Ä—É–∑–∫–∞...</h2>
  <img id="userPhoto" alt="–§–æ—Ç–æ">
  <p>–ó–≤—ë–∑–¥—ã: <span id="stars">0</span></p>
  <p>–ü–æ—Å–ª–µ–¥–Ω–∏–π –∫–µ–π—Å: <span id="lastItem">-</span></p>
  <button onclick="buyCase()">–û—Ç–∫—Ä—ã—Ç—å –∫–µ–π—Å –∑–∞ 1 ‚≠ê</button>
</body>
</html>
